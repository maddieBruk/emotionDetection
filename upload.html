<!doctype html>
<html lang="en">
  <head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-H0NW5Z2MYC"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-H0NW5Z2MYC');
    </script>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Xanh+Mono:ital@1&display=swap" rel="stylesheet">
    <title> Emotion Detection WebApp</title>
    <meta name="description" content="Simple Machine Learning Model into an WebApp using TensorFlow.js">
    <meta name="keywords" content="Machine Learning, TensorFlow.js">

  </head>

  <body>
    <!--<script type="text/javascript" src="http://livejs.com/live.js"></script>-->
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.5.2/dist/tf.min.js"></script>
    <h1>Emotion Detection WebApp</h1>
    <!-- <form id="upload-image" action="load_image()"> -->
    <form id="upload-image">
      <label for="img">Upload an image</label>
      <input type="file"  accept="image/*" name="image" id="file"  onchange="load_and_predict(event)">
    </form>

    <img id="output" width="200" />	
    <input type="submit" value="Clear">
   <p id="pasteIt"> </p>
    <script>

    var emotions = ["Angry", "Happy", "Sad", "Surprised", "Neutral"];

    tf.loadLayersModel('model/model.json').then(function(model) {
      window.model = model;
    });

    // Credits to https://www.webtrickshome.com/faq/how-to-display-uploaded-image-in-html-using-javascript
    // var loadFile = function(event) {
    //   var image = document.getElementById('output');
    //   image.src = URL.createObjectURL(event.target.files[0]);
    // };
    var clear = function() {
      image.src = null;
    }

    var load_and_predict = function(event) {
      console.log("hi");
      if (window.model) {

        var image = document.getElementById('output');
        image.width = 48;
        image.height = 48;
        image.src = URL.createObjectURL(event.target.files[0]);

        image.onload = () => {
          var t = tf.browser.fromPixels(image);
          t.print();
          console.log(t);
          console.log(t);
          window.model.predict(t.reshape([1,48,48,3])).array().then(function(probs){
            probs = probs[0];
            console.log(probs);
            document.getElementById("pasteIt").innerHTML="";
            var highest=0;
            var num=0;
            var index=-1;
            for (i = 0; i < probs.length; i++) {
              console.log(emotions[i], probs[i]);
              num=probs[i];
              if(num>highest){
                highest=num;
                index=i;
              }
            }
            document.getElementById("pasteIt").innerHTML+=emotions[index]+" "+"\n";
            document.getElementById("pasteIt").innerHTML+=probs[index].toFixed(4)*100+"% \n";
            

          });
        } 
      } else {
        // The model takes a bit to load, if we are too fast, wait
        setTimeout(function(){load_and_predict(event)}, 50);
      }
    }
    
    </script>

  </body>
</html>